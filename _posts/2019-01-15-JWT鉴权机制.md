---
layout:     post
title:      JWT鉴权机制和spring security
date:       2019-01-15
author:     yunzhs
header-img: img/Mayuri with Sakura.jpg
catalog: true
tags:
    - JWT
typora-root-url: ..
typora-copy-images-to: ..\img\posts
---

### 1.JWT是什么？

JWT的全称是Json Web Token，说白了就是一个用json来传递token的一个机制。

它特别适用于分布式站点的单点登录（SSO）场景。JWT的声明一般被用来在**身份提供者**和**服务提供者**间传递**被认证**的用户身份信息，以便于从**资源服务器**获取资源，也可以增加一些额外的其它业务逻辑所必须的声明信息，该token也可直接被用于**认证**，也可被**加密**。

### 2.JWT相比于传统的session的优势

#### 基于session的认证

通过http协议来进行的,而http是一种无状态的协议,这就意味着如果用户向我们的应用提供了用户名和密码来进行用户认证，那么下一次请求时，用户还要再一次进行用户认证才行,也就是将cookie保存在浏览器中.

但是随着用户的增加,以及多客户端的扩展,就会暴露很多问题:

**Session**: 每个用户经过我们的应用认证之后，我们的应用都要在服务端做一次记录，以方便用户下次请求的鉴别，通常而言session都是保存在内存中，而随着认证用户的增多，服务端的开销会明显增大。

**扩展性**: 用户认证之后，服务端做认证记录，如果认证的记录被保存在内存中的话，这意味着用户下次请求还必须要请求在**这台服务器**上,这样才能拿到授权的资源，这样在分布式的应用上，相应的**限制了负载均衡**器的能力。这也意味着限制了应用的扩展能力。

**CSRF**: 因为是基于cookie来进行用户识别的, cookie如果被截获，用户就会很容易受到跨站请求伪造的攻击。

#### 基于token的鉴权机制

基于token的鉴权机制类似于http协议也是无状态的，它不需要在服务端去保留用户的认证信息或者会话信息。这就意味着基于token认证机制的应用不需要去考虑用户在哪一台服务器登录了，这就为应用的扩展提供了便利。

流程上是这样的：

- 用户使用用户名密码来请求服务器
- 服务器进行验证用户的信息
- 服务器通过验证发送给用户一个token
- 客户端存储token，并在每次请求时附送上这个token值
- 服务端验证token值，并返回数据

这个token必须要在每次请求时传递给服务端，它应该保存在请求头里， 另外，服务端要支持`CORS(跨来源资源共享)`策略，一般我们在服务端这么做就可以了`Access-Control-Allow-Origin: *`。

### 3.基本流程

简而言之,需要先走服务器的auth接口，用账号和密码换取token，之后每个接口的请求都需要带着token去访问，否则就是鉴权失败.

![1821058-2e28fe6c997a60c9](/img/posts/1821058-2e28fe6c997a60c9.webp)

### 4.spring security介绍

​	Spring Security 基于 Spring 框架，Web 应用的安全性包括**用户认证**（Authentication）和**用户授权**（Authorization）两个部分。

​	用户认证指的是验证某个用户是否为系统中的合法主体，也就是说用户能否访问该系统。用户认证一般要求用户提供用户名和密码。系统通过校验用户名和密码来完成认证过程。

​	用户授权指的是验证某个用户是否有权限执行某个操作。在一个系统中，不同用户所具有的权限是不同的。比如对一个文件来说，有的用户只能进行读取，而有的用户可以进行修改。一般来说，系统会为不同的用户分配不同的角色，而每个角色则对应一系列的权限。

对于上面提到的两种应用情景，Spring Security 框架都有很好的支持。在用户认证方面，Spring Security 框架支持主流的认证方式，包括 HTTP 基本认证、HTTP 表单验证、HTTP 摘要认证、OpenID 和 LDAP 等。在用户授权方面，Spring Security 提供了基于角色的访问控制和访问控制列表（Access Control List，ACL），可以对应用中的领域对象进行细粒度的控制

![1548144393889](/img/posts/1548144393889.png)