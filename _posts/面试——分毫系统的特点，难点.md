

#### 分毫的技术架构：

中台系统

已springBoot为基础，k8s作为分布式架构
使用阿里云提供的服务器，消息服务mns，对象存储oss等，sls日志分析
Apollo，xxljob

#### 分毫的业务难点

社保，商保。
代理，外包，派遣，集团
全国上百个城市，政策不统一
不同的险种，大额医疗，长期护理险
三险，五险，五险不合一，存在，补差（增员减员），补缴，预收，预收结算，服务费
复杂的上游系统，保险配置，人员信息，商户信息，合同信息，参保信息，预收结算信息等等
下游系统，财务，数据分析，客户公司推送
客户定制化的需求，账单样式，出账时间，计算方式等等

#### 分毫的技术难点

账单计算：本质上就是各个险种基数乘比例，但是这个基数，比例，怎么去定？要从上游系统取配置信息，包括每个城市的基数上下限，基数比例，单位个人差别；
 	 合同：需要从合同中获取各个公司的类别，是外包派遣还是代理，服务费类别，是按费率还是固                    定。
 	账单状态分为未确认，已确认，预发布，已发布，已删除
 	类别分为大库小库，小库只收服务费，服务费还低消的概念。
 	还要去看人的状态，看他是要增员还是减员，要补缴。来确定收费方案
 	
隔月比差：一个复杂迭代。正常的账单默认会对比上一个月的账单，以解决增员减员，基数调整等问题，
                 儿隔月比差，主要是解决多个月前的问题，因为会导入操作，业务经常会修改几个月前的数据，这就会导致数据会和已出账单的数据有差异，这时候就会有隔月比差的操作，这是一个人工的操作。

灵活性：每个地区的修改程度不一样，一些地区的修改十分离谱，能改一年内的数据
                 
预收：提前收钱

预收结算：把提前收的钱和实际收的钱进行对比，结算
 	          

账单的准确性：通过各种校验程序，与上下游数据进行同步，比如支付系统实缴对比（政府实缴和我们的缴纳）

账单的可配置化，能够各种复杂场景，将业务拆分成最小单元，通过拼装的方式实现业务。  自定义字段
              实现类似于规则引擎的效果。

账单的可视化，定制化账单，生成各种复杂的excel，pdf，满足客户的定制化需求

账单计算的速度。通过优化代码，优化sql（包括表结构，查询语句，减少查询次数），优化查询上游接口，优化数据推送等。

数据导出的速度

#### 遇到过的问题

1、慢sql问题，order by id 问题

2、定制化账单导出时om问题

3、账单的可配置化，小重构，如何去设计他

4、账单的计算速度，从上游接口（分析接口调用速度arths），优化导出逻辑，优化慢sql


#### 重构
业务重构：把之前写死的内容改为客配置
代码重构：表重构。
                  主表双写，小表直接迁移（数据不一致，数据慢，通过消息同步（刚开始代码同步，导致业务变慢））

如何把定制化账单系统做成一个通用的系统


#### CPU占用过高可能是什么问题？

大量循环递归
线程过多，切换
数据量大



